stages:
- build
- deploy

workflow:
  rules:
  - if: $CI_COMMIT_MESSAGE =~ /-k8s$/


build_job:
  stage: build
  image: gcr.io/kaniko-project/executor:v1.11.0-debug
  script:
  - echo "Construction de l'application..."
  - echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
  - /kaniko/executor --context ./pli --build-arg EACT_APP_BACKEND=https://pli-dev.ketsuna.com  --dockerfile Dockerfile --destination crissime/pli-front:dev-${CI_JOB_ID} --cache=true
  - /kaniko/executor --context ./signaling --build-arg CORS_ORIGIN=https://pli-dev.ketsuna.com  --dockerfile Dockerfile --destination crissime/pli-brack:dev-${CI_JOB_ID} --cache=true

deploy_to_dev:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
  - cat $KUBECONFIG_DATA | base64 -d > kubeconfig
  - export KUBECONFIG=$CI_PROJECT_DIR/kubeconfig
  - echo "mise a jour des images"
  - 'sed -i "s|image: crissime/pli-front:.*|image: crissime/pli-front:dev-${CI_JOB_ID}|g" k8s-dev/front/deploy_front.yaml'
  - 'sed -i "s|image: crissime/pli-back:.*|image: crissime/pli-back:dev-${CI_JOB_ID}|g" k8s-dev/backend/deploy_back.yaml'
  - echo "Déploiement sur l'environnement de développement..."
  - kubectl apply -f k8s-dev/front --namespace=dev
  - kubectl apply -f k8s-dev/backend --namespace=dev
